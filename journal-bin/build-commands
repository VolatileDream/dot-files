#!/bin/bash

# the name of this source
SRC='commands'

if [ $# -eq 0 ]; then
	echo "$0: [--clean] [--full] [--incremental] file"
	echo "$0: --query ..."
	exit 1
fi

# standard config reading stuff
config(){
	KEY="$1" ; shift
	if [ $# -gt 0 ]; then
		journal config "$SRC" "$KEY" "$@"
	else
		journal config "$SRC" "$KEY"
	fi
}

ensure-config(){
	KEY="$1" ; shift ; DEFAULT="$@"
	VALUE="$(config "$KEY" )"
	if [ -z "$VALUE" ];then
		config "$KEY" "$DEFAULT"
		VALUE="$DEFAULT"
	fi
	echo "$VALUE"
}

# stuff that should be in config
# this doesn't auto expand to $HOME, but embeds the string '$HOME' in the config
# it gets auto expanded when we read it.
PATH_AUGMENT="$(ensure-config augment-path '$HOME/bin/journal-bin/commands')"
# were to put all the files we generate
GENERATED="$(journal config journal generated)"

build(){
	# as far as journal-parse is concerned, there's no difference
	# between full and incremental, except for the files that get
	# passed to it

	cat "$1" |
	"$HOME/bin/journal-bin/journal-parse"	\
		--path "$PATH_AUGMENT:$PATH"	\
		--output "$GENERATED"		\
		--stdin
}

clean(){
	# um.... figure out what files were generated and delete them.
	echo "Cleaning up..."
}

usage(){
	echo "Usage: $0 <command>"
	echo "  Query generated files from build-commands"
	echo
	echo "Commands are:"
	echo " - events"
	echo " - quotes"
}

query(){

	if [ $# -eq 0 ]; then
		usage
		exit 1
	fi

	while [ $# -gt 0 ]; do

		case $1 in
			events)
				cat "$(journal config journal generated)/life.md"
				;;
			quotes)
				( echo .mode lines ; sqlite-select quotes \*) |
					sqlite  "$(journal config journal generated)/quote.db"
				;;
			*)
				usage
				exit 1
				;;
		esac
		shift
	done
}

# Only one of these will ever be specified,
#  and they all have slightly different syntax.
COM=$1 ; shift
case $COM in
	# $0 --full <file>
	--full)
		build "$1" ;;
	# $0 --incremental <file>
	--incremental)
		build "$1" ;;
	# $0 --clean
	--clean)
		clean ;; # $# == 0
	# $0 --query args*
	--query)
		query "$@" ;; # $# >= 0
	*)
		echo "Unknown command specified to source: $COM" ;;
esac

