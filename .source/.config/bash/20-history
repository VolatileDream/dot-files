# don't put duplicate lines or lines starting with space in the history.
# See bash(1) for more options
HISTCONTROL=ignoreboth

# Set the time format to empty, to force bash to write the timestamp to storage.
HISTTIMEFORMAT=" "

# don't allow for editing of history lines (backspace after Ctrl-r)
set revert-all-at-newline on

# for setting history length see HISTSIZE and HISTFILESIZE in bash(1)
HISTSIZE=1000
HISTFILESIZE=2000

# do really fancy stuff with history (keep it "forever")
## Sourced: https://twitter.com/michaelhoffman/status/639178145673932800
# this breaks CTRL-R
HISTFILE="${HOME}/.history/$(date -u +%Y/%m/%d)/${HOSTNAME}_$$_$(date -u +%H-%M)"
if [ -z "$HIST_PARENT" ]; then
    # This is required because there's no simpler way to pass the
    # PID of the top level history to any children.
    export HIST_PARENT="$$"
else
    # Child shells will have their own history. This is nice for things like
    # vim, where we can continue to run the same command set as we work on
    # various files and things.
    HISTFILE="${HOME}/.history/$(date -u +%Y/%m/%d)/${HOSTNAME}_${HIST_PARENT}_child"
fi
mkdir -p "${HISTFILE%/*}/"

# append to the history file, don't overwrite it.
# This is necessary for VIM setup, the rest of the time it's fine.
shopt -s histappend

# include history files, attempt to restore "normal" history.
# don't include by default, since we don't want to have bloated forever history,
# unless we're explicitly sure we want it.
history-refresh(){
    for file in ~/.history/*/*/*/* ; do
        history -r "$file"
    done
}

# C-r breaks once you have a bunch of history files so we have to rebuild it
hp () {
    # 1/10_000 error for 1_000_000 elements
    # lines must be less than 4096 characters
    local line=`cat ~/.history/*/*/*/* | bloom --false-positive 0.00001 --elements 1000000 --remove-duplicates | pick`

    if [ -n "$line" ]; then
        history -s "$line"
        eval "$line"
    fi
}
# define an alternative for systems where we may not have 'bloom' and 'pick'
hhg () { grep --recursive --no-filename "$@" ~/.history | uniq ; }

