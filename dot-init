#!/bin/bash
#    init-dot-files - creates hard links to dot files, and generates others

if ! ls dot-init >/dev/null 2>/dev/null; then
	# sneaky way to check we're executing in the dot file repo
	echo "dot-init can only be used inside the dot file repo" 
	exit
fi

# Source the config stuff
source ".config/dot-config"

mirror-dir-structure(){

    if [[ $# -lt 2 ]] ; then
        echo "mirror-dir-structure requires input + output directories"
        return
    fi

    # first setup directories
    for dir in ` cd $1 ; find . -type d ` ; do
        if [[ ! -d "$2/$dir" ]]; then
            # directory doesn't exist
            mkdir -p "$2/$dir"
        fi
    done # directories
}

do-generate(){
    mkdir -p "$GEN_DIR"
    
    mirror-dir-structure "$GEN_DIR" "$HOME"

    for file in ` cd "$GEN_DIR" ; find . -type f ` ; do

        tmp=`mktemp`

	if [ -x "$GEN_DIR/$file" ]; then
	        "$GEN_DIR/$file" "$PWD" > "$tmp"

	        if [[ -f "$HOME/$file" ]]; then
	            # use diff because this file was generated
	            if [ ! diff "$HOME/$file" "$tmp" ] ; then
	                echo "$HOME/$file already exists and differs from $SOURCE/$file output"
	                echo "generating to  $HOME/$file.1 instead"
	                mv "$tmp" "$HOME/${file}.1"
	            fi
	        else
	            mv "$tmp" "$HOME/$file"
	        fi
	fi # executable
    done
}

do-linking(){

    mkdir -p $SRC_DIR

    linkFile(){
        out="$HOME/${1}${2}"
        if [[ -f "$out" ]] ; then
            rm "$out"
        fi
        ln "$SRC_DIR/$1" "$out"
    }

    mirror-dir-structure "$SRC_DIR" "$HOME"

    for file in ` cd $SRC_DIR ; find . -type f ` ; do

        if [[ -f "$HOME/$file" ]]; then
            if [ ! "$HOME/$file" -ef "$SRC_DIR/$file" ] ; then
                echo "$HOME/$file already exists and differs from $SOURCE/$file"
                echo "linked source to $file.1 instead"
                linkFile "$file" ".1"
            fi
        else
            # don't exist yet
            linkFile "$file"
        fi
    done
}

do-linking
do-generate
