#!/bin/bash

# configuration file
CONFIG="$HOME/.config/journal-config.ini"

# get conrch stuff for config
source "$HOME/bin/conch"

config(){

	if [ ! -e "$CONFIG" ]; then
		# create ?
		echo "Config file doesn't exist."
		exit 2
	fi

	if [ $# -eq 0 ]; then
		cat "$CONFIG"
	else
		if [ $# -gt 2 ] ; then
			section="$1" ; shift
			key="$1" ; shift

			ini "$CONFIG" "$section" "$key" "$@"
		else
			# get the value we wanted, and substitute
			# any $HOME value with the environment variable
			VAR="$(ini "$CONFIG" "$@" | sed "s_\${HOME}_${HOME}_" )"
			if [ ! -z "$VAR" ]; then
				conch config "$VAR"
			fi
		fi
	fi
}

err(){
	echo -e "\e[31m" "$@" "\e[0m" >> /dev/stderr
}

require-journal(){
	# stuff that should be in configs
	JOURNAL="$(config journal location)" 	# file for for archivist

	if [ -z "$JOURNAL" ]; then
		err "journal hasn't been configured for use yet."
		err "Run: 'journal create' to configure it."
		exit 1
	fi
	# the journal location is a directory
	if [ ! -d "$JOURNAL" ]; then
		err "Unable to locate journal (${JOURNAL})."
		err "Are you sure it exists?"
		exit 1
	fi
}

# takes the date-time as arg1
temp-file(){
	# no spaces or slashes in file name.
	mktemp --tmpdir=/tmp "XXXXXXXX--$(echo $1 | tr '/ ' '--')"
}

query(){
	require-journal
	QUERY_PREFIX="$(config journal bin)/$(config journal source-prefix)"
	if [ $# -lt 1 ]; then
		err "query requires a data source and query be specified"
		SOURCES=$(ls "${QUERY_PREFIX}"* 2> /dev/null | sed "s_${QUERY_PREFIX}__" | tr '\n' ' ')
		err "Valid sources are: $SOURCES"
		exit 1
	fi

	SRC="$1" ; shift
	COM="${QUERY_PREFIX}${SRC}"
	if [ -e "$COM" ]; then
		if [ -x "$COM" ]; then
			# pass the query along
			"$COM" --query "$@"
		else
			err "Cannot query data source '$SRC': ${QUERY_PREFIX}${SRC} is not executable"
			exit 1
		fi
	else
		err "Cannot query data source '$SRC': could not find ${QUERY_PREFIX}${SRC}"
		exit 1
	fi
}

build(){
	require-journal
	# Args are laid out in 2 groups:
	#  pass along flags
	# --
	#  sources
	ARGS=""
	BUILD_PREFIX="$(config journal bin)/$(config journal source-prefix)"
	while [ $# -gt 0 ]; do
		last_arg="$1" ; shift
		if [ "$last_arg" = "--" ]; then
			break
		fi
		ARGS="$ARGS $last_arg"
	done

	if [ $# -gt 0 ]; then
		SOURCES="$@"
	else
		SOURCES=$(ls "${BUILD_PREFIX}"* 2> /dev/null | sed "s_${BUILD_PREFIX}__")

		if [ $? -ne 0 -o -z "$SOURCES" ]; then
			# nothing to build
			return
		fi
		echo -n "Running sources: $SOURCES" | tr '\n' ' '
		echo
	fi

	for SRC in $SOURCES ; do
		COM="${BUILD_PREFIX}${SRC}"
		if [ -e "$COM" ]; then
			if [ -x "$COM" ]; then
				mkdir -p "$(config journal generated)"
				"$COM" $ARGS
				local exit_status=$?
				if [ $exit_status -ne 0 ]; then
					err "Error building $SRC, non-zero exit status: $exit_status"
				fi
			fi
		else
			err "Unable to build $SRC: could not find ${BUILD_PREFIX}${SRC}"
		fi
	done
}

update(){
	require-journal

	if [ ! -e "$JOURNAL/last-journal-entry" ]; then
		return 0
	fi

	FORMAT="%Y-%m-%d"

	# last entry date
	LAST="$(cat "$JOURNAL/last-journal-date")"
	# current date
	NOW="$(date +$FORMAT)"

	if [ "$NOW" != "$LAST" ]; then

		# Check to make sure the user hasn't accidentally run update
		read -p "You have an existing entry for: $LAST, commit it to log? (y/n) "
		if [[ "$REPLY" != "Y" && "$REPLY" != "y" ]]; then
			return
		fi

		# Update the immutable archive of entries
		cat "$JOURNAL/last-journal-entry" | archivist -a "$JOURNAL" submit "$LAST"

		if [ $? -ne 0 ]; then
			# error submitting, what should we do?
			# We shouldn't lose user data
			err "Error adding journal entry to log"
			exit 3
		fi

		# clean up, $JOURNAL/last-journal-entry was moved to $tmp
		rm "$JOURNAL/last-journal-date" "$JOURNAL/last-journal-entry"

		# use a temporary file so that none of the data sources every
		#  attempt to look at or open the last-journal-entry file by mistake.
		tmp="$(temp-file "$LAST")"

		# get the properly formatted archivist entry for parsing and building.
		archivist -a "$JOURNAL" view "$(archivist -a "$JOURNAL" date)" > "$tmp"

		# Now run an incremental update
		build --incremental "$tmp" --

		# cleanup the temp file
		rm "$tmp"
	fi
}

edit(){
	require-journal

	if [ ! -e "$JOURNAL/last-journal-entry" ]; then
		date "+%Y-%m-%d" > "$JOURNAL/last-journal-date"
	fi
	# if the user doesn't write to this file, it will remain empty.
	# this is a nice way to ignore empty entries.
	sensible-editor "$JOURNAL/last-journal-entry"
}

entries(){
	require-journal
	archivist -a "$JOURNAL" entries
}

view(){
	require-journal
	# all entries must be shown with a single command invocation
	# this prevents the user from having to exit the pager
	# again and again and again, and get really frustrated
	if [ ! -z "$*" ]; then
		archivist -a "$JOURNAL" view "$@" | sensible-pager
	fi
}

create(){
	if [ ! -z "$JOURNAL" ]; then
		err "Journal is already set ($JOURNAL)."
		exit 1
	fi
	# the only command that can be run without a journal
	# it bootstraps the rest of the app, and configures
	#  the location of the journal for further use
	echo "Creating a journal..."
	configured=0
	file_location=""
	gen_location=""
	while [ $configured -eq 0 ]; do
		echo "Where should the journal files live?"
		read -p "> " file_location
		echo "Where should generated data files go?"
		read -p "> " gen_location
		echo "Put the journal here: '$file_location'"
		echo " and put the generated files here: '$gen_location'"
		echo "Is that correct?"
		read -p "(y/n) > " confirm
		if [ "$confirm" = "y" -o "$confirm" = "Y" ]; then
			configured=1
		else
			echo "Okay, let's try again."
		fi
	done
	# we set some defaults here, because they just make sense.
	config journal bin "\${HOME}/bin/journal-bin"
	config journal source-prefix "source-"
	# user entered variables
	# the location, modified to use '${HOME}' instead of ~
	file_location="$(echo $file_location | sed 's_^~/_\${HOME}/_')"
	config journal location "$file_location"
	config journal generated "$gen_location"

	# update the journal location so we can run update + edit after this
	JOURNAL="$(config journal location)"
}

# TODO do option parsing here

if [ $# -eq 0 ]; then
	JOURNAL="$(config journal location)"
	if [ -z "$JOURNAL" ]; then
		create
	fi

	# invoke update first
	update
	edit
else
	COMMAND="$1" ; shift
	case $COMMAND in
		build)
			require-journal
			tmp="$(mktemp)"
			archivist -a "$JOURNAL" replay > "$tmp"
			build --full "$tmp" -- "$@"
			rm "$tmp"
			;;
		clean)
			# trust that each source will clean up after itself
			build --clean -- "$@"
			;;
		config)
			config "$@" ;;
		create)
			# setup the journal at the beginning
			create ;;
		edit)
			# the only way to edit yesterdays entry
			edit ;;
		entries)
			entries ;;
		query)
			query "$@" ;;
		search)
			query index "$@" ;;
		update)
			update ;;
		view)
			view "$@" ;;
		help|-h|--help)
			echo "Usage: $0 [options] <command>"
			echo "  Update your private journal"
			echo
			echo "Available commands are:"
			echo "- build [source]*"
			echo "    rebuilds the generated files for the specified sources, defaults"
			echo "    to rebuilding all data sources."
			echo
			echo "- clean [source]*"
			echo "    removes all generated files for the specified sources, defaults"
			echo "    to removing files for all sources"
			echo
			echo "- config <source> <key> [value]"
			echo "    reads or writes the config for the specified source variable."
			echo "    without arguments it dumps the config"
			echo
			echo "- edit"
			echo "    edit the most recent journal entry (default)"
			echo
			echo "- entries"
			echo "    lists all the entry dates in the journal"
			echo
			echo "- query <source> query*"
			echo "    query the generated data from the specific source"
			echo
			echo "- search query"
			echo "    shortcut for 'query index'"
			echo
			echo "- update"
			echo "    if the LATEST entry is not for the current date it"
			echo "    updates the LATEST entry to point to the current date then"
			echo "    runs an incremental update of all generated data sources"
			echo
			echo "- view [year[smonth[-day[ hour[:minute[:second]]]]]]*"
			echo "    view a particular set of date entries, or range of dates"
			echo
			echo "Building your own source:"
			echo " There is 2 necesarry things a source needs to work with journal."
			echo " - The command must start with 'journal config journal source-prefix'"
			echo " - It must be located in the folder: 'journal config journal bin'"
			echo
			echo "The source must accept a particular flag set:"
			echo " * --full \$file : the source is given the entire journal and must"
			echo "    recreate it's dataset from the source."
			echo " * --clean : the source erases any generated files that are stored"
			echo "    with the journal, is usually preceeded by a --full"
			echo " * --incremental \$file : the source is given a single journal entry,"
			echo "    and must update it's dataset using the entry."
			echo " * --query a1 ... aN : the source is given a query that it must resolve"
			echo "    for the user. The query is passed as is from 'journal query'."
			echo "    The source is responsible for displaying the resultant data."
			;;
		*)
			err "Journal command '$COMMAND' not found"
			exit 1
			;;
	esac
fi

